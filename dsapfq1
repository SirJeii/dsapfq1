import React, { useState, useEffect } from 'react';
import { AlertTriangle, CheckCircle, XCircle, Award, EyeOff, Play, RefreshCw } from 'lucide-react';

const questions = [
  {
    question: "What defines how a computation is divided into tasks, assigned to processors, and executed simultaneously?",
    options: ["Algorithmic Complexity", "Parallel Algorithm Model", "Multithreading", "Sequential Processing"],
    answer: "Parallel Algorithm Model"
  },
  {
    question: "In parallel algorithm terminologies, what is the unit of computation executed independently?",
    options: ["Processor", "Granularity", "Task", "Thread"],
    answer: "Task"
  },
  {
    question: "What term describes the amount of computation per communication?",
    options: ["Synchronization", "Throughput", "Latency", "Granularity"],
    answer: "Granularity"
  },
  {
    question: "Which parallel model distributes a large data set into smaller chunks where each processor executes the same instruction?",
    options: ["Task Graph Model", "Work Pool Model", "Data-Parallel Model", "Pipeline Model"],
    answer: "Data-Parallel Model"
  },
  {
    question: "SIMD (Single Instruction, Multiple Data) architectures are the foundation of which model?",
    options: ["Master-Worker Model", "Data-Parallel Model", "Hybrid Model", "Pipeline Model"],
    answer: "Data-Parallel Model"
  },
  {
    question: "Which model represents tasks and their dependencies using a Directed Acyclic Graph (DAG)?",
    options: ["Task Graph Model", "Data-Parallel Model", "Work Pool Model", "Master-Worker Model"],
    answer: "Task Graph Model"
  },
  {
    question: "In which model are all tasks stored in a shared queue, allowing processors to 'pull' work as they become idle?",
    options: ["Pipeline Model", "Master-Worker Model", "Work Pool Model", "Hybrid Model"],
    answer: "Work Pool Model"
  },
  {
    question: "Which model uses a central controller to distribute tasks to several worker processors?",
    options: ["Work Pool Model", "Master-Worker Model", "Task Graph Model", "Pipeline Model"],
    answer: "Master-Worker Model"
  },
  {
    question: "Which parallel model divides a computation into ordered stages, similar to an assembly line?",
    options: ["Pipeline Model", "Hybrid Model", "Data-Parallel Model", "Master-Worker Model"],
    answer: "Pipeline Model"
  },
  {
    question: "What concurrency technique allows a single process to run multiple independent sequences of instructions?",
    options: ["Virtualization", "Multithreading", "Pipelining", "Partitioning"],
    answer: "Multithreading"
  },
  {
    question: "Which data structure allows multiple threads to safely enqueue and dequeue items without explicit synchronization?",
    options: ["Linked List", "Binary Tree", "Concurrent Queue", "Stack"],
    answer: "Concurrent Queue"
  },
  {
    question: "Which type of queue blocks threads attempting to enqueue when full or dequeue when empty?",
    options: ["Priority Queue", "Blocking Queue", "ConcurrentLinkedQueue", "Circular Queue"],
    answer: "Blocking Queue"
  },
  {
    question: "Which data structures rely on atomic operations instead of traditional locking mechanisms (mutexes)?",
    options: ["Synchronized Collections", "Immutable Data Structures", "Lock-Free/Wait-Free Data Structures", "Blocking Queues"],
    answer: "Lock-Free/Wait-Free Data Structures"
  },
  {
    question: "What characteristic makes Immutable Data Structures inherently thread-safe?",
    options: ["They block all threads", "They cannot be modified after creation", "They use mutexes", "They have low latency"],
    answer: "They cannot be modified after creation"
  },
  {
    question: "What notation is used to represent algorithmic complexity?",
    options: ["Big O notation", "Lambda notation", "Binary notation", "Sigma notation"],
    answer: "Big O notation"
  },
  {
    question: "Which complexity denotes 'Constant Time'?",
    options: ["O(n)", "O(log n)", "O(1)", "O(n^2)"],
    answer: "O(1)"
  },
  {
    question: "Binary search in a sorted array typically has which time complexity?",
    options: ["O(1)", "O(n)", "O(log n)", "O(n^2)"],
    answer: "O(log n)"
  },
  {
    question: "Which time complexity is typical for algorithms with nested loops, like Bubble Sort?",
    options: ["O(n)", "O(n log n)", "O(n^2)", "O(2^n)"],
    answer: "O(n^2)"
  },
  {
    question: "O(2^n) represents which type of time complexity?",
    options: ["Linear Time", "Quadratic Time", "Exponential Time", "Cubic Time"],
    answer: "Exponential Time"
  },
  {
    question: "What is the formula for 'Turn Around Time'?",
    options: ["Completion Time - Arrival Time", "Turn Around Time - Burst Time", "Completion Time + Burst Time", "Arrival Time - Waiting Time"],
    answer: "Completion Time - Arrival Time"
  },
  {
    question: "Which scheduling method runs a process to completion without forcibly taking the CPU away?",
    options: ["Preemptive", "Non-preemptive", "Round Robin", "Multilevel Feedback Queue"],
    answer: "Non-preemptive"
  },
  {
    question: "Which scheduling algorithm executes processes in the order they arrive in the ready queue?",
    options: ["SJF", "SRTF", "FCFS", "Round Robin"],
    answer: "FCFS"
  },
  {
    question: "What is a major disadvantage of the Shortest Job First (SJF) algorithm?",
    options: ["High overhead", "Complex implementation", "Starvation of long processes", "Frequent context switching"],
    answer: "Starvation of long processes"
  },
  {
    question: "Which algorithm is the preemptive version of Shortest Job First?",
    options: ["FCFS", "Round Robin", "SRTF", "Priority Scheduling"],
    answer: "SRTF"
  },
  {
    question: "In Priority Scheduling, what technique is often used to prevent starvation of low-priority processes?",
    options: ["Paging", "Aging", "Swapping", "Blocking"],
    answer: "Aging"
  },
  {
    question: "Which preemptive algorithm gives each process a fixed time slice (quantum)?",
    options: ["Round Robin", "FCFS", "SJF", "Priority Scheduling"],
    answer: "Round Robin"
  },
  {
    question: "What is the best use case for Round Robin scheduling?",
    options: ["Batch processing", "Interactive and multi-user environments", "Real-time sensor systems", "Background jobs"],
    answer: "Interactive and multi-user environments"
  },
  {
    question: "Which scheduling method divides processes into multiple queues with different scheduling policies (e.g., foreground vs background)?",
    options: ["Multilevel Queue (MLQ)", "FCFS", "SJF", "Round Robin"],
    answer: "Multilevel Queue (MLQ)"
  },
  {
    question: "What distinguishes Multilevel Feedback Queue (MLFQ) from standard MLQ?",
    options: ["It uses only one queue", "Processes can move between queues", "It is non-preemptive", "It ignores CPU usage"],
    answer: "Processes can move between queues"
  },
  {
    question: "Wait-Free data structures are particularly useful for which type of systems?",
    options: ["Batch processing systems", "Real-time systems requiring predictable execution", "Single-threaded applications", "Offline storage systems"],
    answer: "Real-time systems requiring predictable execution"
  }
];

const QuizApp = () => {
  const [gameState, setGameState] = useState('start'); // start, playing, result
  const [fullName, setFullName] = useState('');
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [tabSwitches, setTabSwitches] = useState(0);
  const [userAnswers, setUserAnswers] = useState([]);
  const [showFeedback, setShowFeedback] = useState(false); // To show immediate correct/wrong status

  useEffect(() => {
    const handleVisibilityChange = () => {
      if (document.hidden && gameState === 'playing') {
        setTabSwitches(prev => prev + 1);
      }
    };

    document.addEventListener("visibilitychange", handleVisibilityChange);

    return () => {
      document.removeEventListener("visibilitychange", handleVisibilityChange);
    };
  }, [gameState]);

  const startQuiz = () => {
    if (fullName.trim() === "") return;
    setGameState('playing');
    setCurrentQuestionIndex(0);
    setScore(0);
    setTabSwitches(0);
    setUserAnswers([]);
    setShowFeedback(false);
  };

  const handleAnswer = (selectedOption) => {
    if (showFeedback) return; // Prevent multiple clicks

    const isCorrect = selectedOption === questions[currentQuestionIndex].answer;
    if (isCorrect) {
      setScore(prev => prev + 1);
    }
    
    setUserAnswers([...userAnswers, { 
      question: questions[currentQuestionIndex].question,
      selected: selectedOption,
      correct: questions[currentQuestionIndex].answer,
      isCorrect 
    }]);

    setShowFeedback(true);

    // Auto advance after short delay
    setTimeout(() => {
      if (currentQuestionIndex < questions.length - 1) {
        setCurrentQuestionIndex(prev => prev + 1);
        setShowFeedback(false);
      } else {
        setGameState('result');
      }
    }, 1000);
  };

  const restartQuiz = () => {
    setGameState('start');
    setFullName('');
    setScore(0);
    setTabSwitches(0);
    setCurrentQuestionIndex(0);
  };

  // --- RENDER START SCREEN ---
  if (gameState === 'start') {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans text-slate-100">
        <div className="max-w-md w-full bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700">
          <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-8 text-center">
            <h1 className="text-3xl font-bold mb-2 text-white">IT2503 Quiz</h1>
            <p className="text-blue-100 opacity-90">Parallel Algorithms & Multithreading</p>
          </div>
          
          <div className="p-8 space-y-6">
            <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 flex gap-3 items-start">
              <AlertTriangle className="text-yellow-500 shrink-0 mt-1" size={20} />
              <div className="text-sm text-yellow-200">
                <p className="font-semibold mb-1">Anti-Cheat Enabled</p>
                <p>Tab switching is monitored. Please stay on this screen during the entire quiz.</p>
              </div>
            </div>

            <div>
              <label className="block text-slate-400 text-sm font-medium mb-2">Enter your Full Name</label>
              <input 
                type="text" 
                value={fullName}
                onChange={(e) => setFullName(e.target.value)}
                placeholder="Juan Dela Cruz"
                className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder-slate-600"
              />
            </div>

            <button 
              onClick={startQuiz}
              disabled={!fullName.trim()}
              className="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-all transform active:scale-95"
            >
              <Play size={20} />
              Start Quiz
            </button>
            
            <p className="text-center text-slate-500 text-xs">
              30 Questions â€¢ Multiple Choice
            </p>
          </div>
        </div>
      </div>
    );
  }

  // --- RENDER PLAYING SCREEN ---
  if (gameState === 'playing') {
    const currentQ = questions[currentQuestionIndex];
    return (
      <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 font-sans text-slate-100">
        <div className="max-w-2xl w-full bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 relative overflow-hidden">
          
          {/* Progress Bar */}
          <div className="absolute top-0 left-0 w-full h-2 bg-slate-700">
            <div 
              className="h-full bg-blue-500 transition-all duration-300 ease-out"
              style={{ width: `${((currentQuestionIndex + 1) / questions.length) * 100}%` }}
            ></div>
          </div>

          <div className="p-8">
            <div className="flex justify-between items-center mb-6 text-slate-400 text-sm font-medium uppercase tracking-wider">
              <span>Question {currentQuestionIndex + 1} of {questions.length}</span>
              <span className="bg-slate-700 px-3 py-1 rounded-full text-slate-300">{fullName}</span>
            </div>

            <h2 className="text-2xl font-semibold mb-8 text-white leading-relaxed">
              {currentQ.question}
            </h2>

            <div className="space-y-3">
              {currentQ.options.map((option, idx) => {
                let buttonClass = "w-full text-left p-4 rounded-xl border-2 transition-all duration-200 font-medium ";
                
                if (showFeedback) {
                  if (option === currentQ.answer) {
                    buttonClass += "bg-green-500/20 border-green-500 text-green-300";
                  } else if (option !== currentQ.answer && idx === currentQ.options.indexOf(userAnswers[currentQuestionIndex]?.selected)) {
                    // This creates a visual glitch since userAnswers might not be updated fast enough for strict React rendering
                    // but for this logic we usually rely on local state or just checking the clicked one.
                    // Simplified logic below:
                  } else {
                    buttonClass += "bg-slate-800 border-slate-700 opacity-50";
                  }
                } else {
                  buttonClass += "bg-slate-750 border-slate-700 hover:border-blue-500 hover:bg-slate-700 text-slate-200";
                }

                return (
                  <button
                    key={idx}
                    onClick={() => handleAnswer(option)}
                    disabled={showFeedback}
                    className={buttonClass}
                  >
                    <div className="flex items-center justify-between">
                      <span>{option}</span>
                      {showFeedback && option === currentQ.answer && <CheckCircle size={20} className="text-green-500" />}
                    </div>
                  </button>
                );
              })}
            </div>
          </div>
          
          <div className="bg-slate-900/50 p-4 text-center text-slate-500 text-xs">
            DO NOT SWITCH TABS
          </div>
        </div>
      </div>
    );
  }

  // --- RENDER RESULT SCREEN ---
  if (gameState === 'result') {
    const percentage = Math.round((score / questions.length) * 100);
    let gradeColor = "text-red-500";
    if (percentage >= 80) gradeColor = "text-green-500";
    else if (percentage >= 60) gradeColor = "text-yellow-500";

    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans text-slate-100">
        <div className="max-w-md w-full bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700">
          <div className="bg-slate-900 p-8 text-center border-b border-slate-700">
            <div className="inline-block p-4 rounded-full bg-slate-800 mb-4 shadow-inner">
              <Award className={gradeColor} size={48} />
            </div>
            <h2 className="text-3xl font-bold text-white mb-2">Quiz Completed!</h2>
            <p className="text-slate-400">{fullName}</p>
          </div>

          <div className="p-8 space-y-6">
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-slate-700/50 p-4 rounded-xl text-center">
                <p className="text-slate-400 text-sm mb-1">Final Score</p>
                <p className={`text-3xl font-bold ${gradeColor}`}>{score}/{questions.length}</p>
              </div>
              <div className={`bg-slate-700/50 p-4 rounded-xl text-center ${tabSwitches > 0 ? 'ring-2 ring-red-500/50' : ''}`}>
                <p className="text-slate-400 text-sm mb-1">Tab Switches</p>
                <div className="flex items-center justify-center gap-2">
                  <EyeOff size={20} className={tabSwitches > 0 ? "text-red-400" : "text-slate-500"} />
                  <p className={`text-3xl font-bold ${tabSwitches > 0 ? "text-red-400" : "text-slate-200"}`}>{tabSwitches}</p>
                </div>
              </div>
            </div>

            {tabSwitches > 0 && (
               <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex gap-3 items-center">
                 <AlertTriangle className="text-red-500 shrink-0" size={20} />
                 <p className="text-sm text-red-200">
                   Irregular activity detected. You left the quiz screen {tabSwitches} times.
                 </p>
               </div>
            )}

            <button 
              onClick={restartQuiz}
              className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
            >
              <RefreshCw size={20} />
              Take Quiz Again
            </button>
          </div>
        </div>
      </div>
    );
  }

  return null;
};

export default QuizApp;
